# ============================================
# CI/CD Pipeline - PhishGuardAI
# Stages: build → test → deploy
# ============================================

stages:
  - build
  - test
  - deploy

# ============================================
# Global Variables
# ============================================
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA
  BACKEND_IMAGE_LATEST: $CI_REGISTRY_IMAGE/backend:latest
  FRONTEND_IMAGE_LATEST: $CI_REGISTRY_IMAGE/frontend:latest

# ============================================
# Templates for Security Scanning
# ============================================
include:
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml

# ============================================
# STAGE 1: BUILD
# ============================================

build:backend:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "Building backend Docker image..."
    - docker build -t $BACKEND_IMAGE -t $BACKEND_IMAGE_LATEST ./backend
    - docker push $BACKEND_IMAGE
    - docker push $BACKEND_IMAGE_LATEST
    - echo "Backend image built successfully"
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  cache:
    key: backend-build-cache
    paths:
      - backend/.cache
  artifacts:
    reports:
      dotenv: build.env
    expire_in: 1 week
  allow_failure: true

build:frontend:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "Building frontend Docker image..."
    - docker build -t $FRONTEND_IMAGE -t $FRONTEND_IMAGE_LATEST ./frontend
    - docker push $FRONTEND_IMAGE
    - docker push $FRONTEND_IMAGE_LATEST
    - echo "Frontend build successful"
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  cache:
    key: frontend-build-cache
    paths:
      - frontend/node_modules
  artifacts:
    reports:
      dotenv: build.env
    expire_in: 1 week
  allow_failure: true

# ============================================
# STAGE 2: TEST
# ============================================

# Note: secret_detection and sast jobs are automatically created by the included templates
# We don't need to redefine them here - the templates handle everything

test:backend-unit:
  stage: test
  image: python:3.12-slim
  before_script:
    - cd backend
    - pip install --no-cache-dir -r requirements.txt
    - pip install pytest pytest-cov pytest-asyncio httpx
  script:
    - echo "Running backend unit tests..."
    - pytest tests/ --cov=app --cov-report=xml:coverage.xml --cov-report=term --cov-report=html:htmlcov -v
    - echo "Backend tests completed"
    - ls -la coverage.xml htmlcov/ || echo "Coverage files generated"
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.xml
    paths:
      - backend/coverage.xml
      - backend/htmlcov/
    expire_in: 1 week
  allow_failure: false

test:frontend-unit:
  stage: test
  image: node:20-alpine
  before_script:
    - cd frontend
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "Running frontend unit tests..."
    - npm run test:coverage
    - echo "Frontend tests completed"
    - ls -la coverage/ || echo "Coverage directory created"
  cache:
    key: frontend-test-cache
    paths:
      - frontend/.npm
      - frontend/node_modules
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: frontend/coverage/cobertura-coverage.xml
    paths:
      - frontend/coverage/
    expire_in: 1 week
  allow_failure: false

test:docker-compose:
  stage: test
  image: docker:24-dind
  services:
    - docker:24-dind
  script:
    - echo "Testing Docker Compose configuration..."
    - docker compose config
    - echo "Docker Compose configuration is valid"
  allow_failure: false

# ============================================
# STAGE 3: DEPLOY
# ============================================

deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to staging environment..."
    - echo "Backend image - $BACKEND_IMAGE"
    - echo "Frontend image - $FRONTEND_IMAGE"
    - echo "Deployment preparation completed"
    - echo "DEPLOYMENT_URL=https://staging.phishguard.example.com" >> deploy.env
  environment:
    name: staging
    url: https://staging.phishguard.example.com
  artifacts:
    reports:
      dotenv: deploy.env
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      when: manual
  allow_failure: false

deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to production environment..."
    - echo "Backend image - $BACKEND_IMAGE"
    - echo "Frontend image - $FRONTEND_IMAGE"
    - echo "Production deployment preparation completed"
    - echo "DEPLOYMENT_URL=https://phishguard.example.com" >> deploy.env
  environment:
    name: production
    url: https://phishguard.example.com
  artifacts:
    reports:
      dotenv: deploy.env
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  allow_failure: false

# ============================================
# Additional Jobs
# ============================================

cleanup:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Cleaning up old artifacts..."
    - echo "Cleanup completed"
  when: on_success
  allow_failure: true
